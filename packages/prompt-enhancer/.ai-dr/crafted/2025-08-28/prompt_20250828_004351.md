# Enhanced Prompt

**ID**: 1eb69952-08a6-47d8-b788-4aba11964606
**Version**: 1.0.0
**Workflow Type**: bug
**Score**: 100/100
**Created**: 2025-08-28T04:43:51.519Z
**Updated**: 2025-08-28T04:43:51.519Z

## Instruction
Diagnose and fix the user login authentication flow. The current implementation is failing silently or with a generic error, preventing users with valid credentials from logging in. Your task is to investigate the entire authentication process, from request validation to session/token generation, identify the root cause, and implement a robust fix with improved error handling and testing.

## Context
**Project Overview**: AI Dr. workflow orchestration system
**Technical Stack**: TypeScript, Bun
### Relevant Files
- `src/routes/auth/login.ts`: File: src/routes/auth/login.ts
- `src/services/authService.ts`: File: src/services/authService.ts
- `src/middleware/auth.ts`: File: src/middleware/auth.ts
- `tests/auth.test.ts`: File: tests/auth.test.ts
### Dependencies
- @ai-sdk/google
- ai
- chalk
- minimatch
- uuid
- yaml
- zod
- @types/bun
- @types/uuid
- @types/minimatch

## Success Criteria
1. ✅ Users with correct credentials can successfully log in and receive an authentication token or session identifier.
2. ✅ Users with an incorrect password receive a clear 'Invalid username or password' error (HTTP 401).
3. ✅ Users with a non-existent username receive the same 'Invalid username or password' error to prevent username enumeration.
4. ✅ The server logs detailed, non-sensitive information about the specific cause of a login failure (e.g., 'User not found', 'Password mismatch for user X').
5. ✅ A new integration test is added in `tests/auth.test.ts` that covers successful login, failed login due to wrong password, and failed login due to non-existent user.
6. ✅ All existing and new tests must pass.

## Constraints
- ⚠️ Do not introduce any new external dependencies for authentication.
- ⚠️ Adhere strictly to the existing coding style and linting configurations.
- ⚠️ Ensure no sensitive data (e.g., passwords, full error stacks) is exposed in API responses.
- ⚠️ Password verification must be done using a constant-time comparison algorithm, such as the one provided by `Bun.password.verify`, to prevent timing attacks.

## Clarifying Questions
1. ❓ What is the specific error message or behavior users are currently experiencing?
2. ❓ Which authentication mechanism is intended to be used (e.g., JWT, sessions)?
3. ❓ Can you confirm the file path for the primary API route handler for login?
4. ❓ Is the project using Bun's built-in `Bun.password` API for hashing and verification?

## Expected Output
**Format**: code
**Structure**: Fixed code with error handling

## Inputs
- **Original Prompt** (text): Fix the login authentication issue

## Validation
**Status**: ✅ Valid
**Score**: 100/100

---
*Generated by AI Dr. Prompt Enhancer*