name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths-ignore:
      - '.ai-dr/**'
      - 'musings/**'
      - 'logs/**'
      - 'docs/**'
      - '*.md'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for comprehensive review

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.21

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Quality Checks
        run: |
          echo "ðŸ” Running automated code quality checks..."
          
          echo "ðŸ“‹ TypeScript Check:"
          if bun run typecheck; then
            echo "âœ… TypeScript check passed"
          else
            echo "âŒ TypeScript errors found"
          fi
          
          echo "ðŸ”§ Linting:"
          if bun run lint; then
            echo "âœ… Linting passed"
          else
            echo "âŒ Linting issues found"
          fi
          
          echo "ðŸ§ª Tests:"
          if bun run test; then
            echo "âœ… Tests passed"
          else
            echo "âŒ Tests failed"
          fi
          
          echo "ðŸ“¦ Build check:"
          if bun run build; then
            echo "âœ… Build successful"
          else
            echo "âŒ Build failed"
          fi

      - name: Add Code Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const reviewTemplate = `## ðŸ¤– Automated Code Review
            
            ### Quality Checks Summary
            This automated review has run the following checks:
            
            | Check | Status |
            |-------|--------|
            | TypeScript | â³ See logs above |
            | ESLint | â³ See logs above |  
            | Tests | â³ See logs above |
            | Build | â³ See logs above |
            
            ### ðŸ“‹ Review Guidelines
            Please ensure your PR follows these standards:
            
            #### Code Quality & Standards
            - âœ… TypeScript strict mode enabled
            - âœ… No \`any\` types used
            - âœ… Kebab-case for files/directories
            - âœ… Absolute imports for workspace packages
            - âœ… Explicit exports
            
            #### Monorepo Structure  
            - âœ… Files in appropriate packages (not root)
            - âœ… Package dependencies properly declared
            - âœ… Turborepo configuration maintained
            
            #### Security & Performance
            - âœ… No hardcoded secrets
            - âœ… Environment variables used properly
            - âœ… Input validation implemented
            - âœ… Error handling included
            
            #### Testing & Documentation
            - âœ… Tests included for new functionality
            - âœ… Documentation updated
            - âœ… README files current
            
            > **Note:** This is an automated review. Manual review by maintainers may still be required.
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewTemplate
            });

