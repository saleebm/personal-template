name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths-ignore:
      - '.ai-dr/**'
      - 'musings/**'
      - 'logs/**'
      - 'docs/**'
      - '*.md'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for comprehensive review

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.2.21

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Quality Checks
        run: |
          echo "🔍 Running automated code quality checks..."
          
          echo "📋 TypeScript Check:"
          if bun run typecheck; then
            echo "✅ TypeScript check passed"
          else
            echo "❌ TypeScript errors found"
          fi
          
          echo "🔧 Linting:"
          if bun run lint; then
            echo "✅ Linting passed"
          else
            echo "❌ Linting issues found"
          fi
          
          echo "🧪 Tests:"
          if bun run test; then
            echo "✅ Tests passed"
          else
            echo "❌ Tests failed"
          fi
          
          echo "📦 Build check:"
          if bun run build; then
            echo "✅ Build successful"
          else
            echo "❌ Build failed"
          fi

      - name: Add Code Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const reviewTemplate = `## 🤖 Automated Code Review
            
            ### Quality Checks Summary
            This automated review has run the following checks:
            
            | Check | Status |
            |-------|--------|
            | TypeScript | ⏳ See logs above |
            | ESLint | ⏳ See logs above |  
            | Tests | ⏳ See logs above |
            | Build | ⏳ See logs above |
            
            ### 📋 Review Guidelines
            Please ensure your PR follows these standards:
            
            #### Code Quality & Standards
            - ✅ TypeScript strict mode enabled
            - ✅ No \`any\` types used
            - ✅ Kebab-case for files/directories
            - ✅ Absolute imports for workspace packages
            - ✅ Explicit exports
            
            #### Monorepo Structure  
            - ✅ Files in appropriate packages (not root)
            - ✅ Package dependencies properly declared
            - ✅ Turborepo configuration maintained
            
            #### Security & Performance
            - ✅ No hardcoded secrets
            - ✅ Environment variables used properly
            - ✅ Input validation implemented
            - ✅ Error handling included
            
            #### Testing & Documentation
            - ✅ Tests included for new functionality
            - ✅ Documentation updated
            - ✅ README files current
            
            > **Note:** This is an automated review. Manual review by maintainers may still be required.
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewTemplate
            });

